<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>BCOM-C — Reports</title>
<link rel="stylesheet" href="../assets/css/bcom.css?v=3" />
<style>
  .rpt-table { width:100%; border-collapse:collapse; font-size:12px; letter-spacing:.5px; }
  .rpt-table th { background:#0e0a06; color:#ccc; font-weight:600; letter-spacing:1.5px; padding:7px 10px; text-align:left; border-bottom:1px solid #1e1008; }
  .rpt-table td { padding:7px 10px; border-bottom:1px solid #120b04; vertical-align:middle; color:#ccc; }
  .rpt-table tr:hover td { background:#0e0905; }
  .rpt-table .empty { text-align:center; color:#2a2a2a; padding:24px; letter-spacing:2px; }
  .rpt-pill { display:inline-block; font-size:9px; letter-spacing:1.5px; padding:2px 7px; border:1px solid; }
  .rpt-pill.pass  { color:#27ae60; border-color:#27ae60; }
  .rpt-pill.fail  { color:#e74c3c; border-color:#e74c3c; }
  .rpt-pill.error { color:#f39c12; border-color:#f39c12; }
  .score-hi  { color:#27ae60; font-weight:700; }
  .score-mid { color:var(--orange); font-weight:700; }
  .score-lo  { color:#e74c3c; font-weight:700; }
  .summary-row { display:flex; gap:12px; flex-wrap:wrap; }
  .sum-chip { border:1px solid #1a0e05; padding:8px 14px; background:#090603; font-size:11px; letter-spacing:1px; color:#ccc; }
  .sum-chip span { display:block; font-size:16px; font-weight:700; color:var(--orange); margin-top:2px; }
  .filter-bar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .filter-bar label { font-size:10px; letter-spacing:1px; color:#ccc; }
</style>
</head>
<body>

<div class="topbar">
  <div class="topbar-title">BCOM-C</div>
  <div class="topbar-right">
    <a class="nav-btn" href="../index.html"><span class="nav-arrow">&#8592;</span> DASHBOARD</a>
    <a class="nav-btn" href="data-gen.html">DATA GEN</a>
    <a class="nav-btn" href="pipeline.html">PIPELINE</a>
    <a class="nav-btn" href="resources.html">RESOURCES</a>
    <a class="nav-btn active" href="reports.html">REPORTS</a>
    <a class="nav-btn" href="orchestrator.html">ORCHESTRATOR</a>
    <div class="timestamp"><span id="clock">--:--:--</span>&nbsp;&nbsp;<span id="datestamp">----/--/--</span></div>
  </div>
</div>

<div class="actionbar">
  <button class="action-btn danger" onclick="triggerAction('RESTART VLLM')">RESTART VLLM</button>
  <button class="action-btn danger" onclick="triggerAction('RESTART LLM')">RESTART LLM</button>
  <button class="action-btn" onclick="exportAll('eval')">&#8659; EXPORT EVALS</button>
  <button class="action-btn" onclick="exportAll('runs')">&#8659; EXPORT RUNS</button>
</div>

<div class="main">
  <div class="info-grid">

    <!-- SUMMARY -->
    <div class="info-card">
      <div class="info-card-hdr">Session Summary</div>
      <div class="summary-row">
        <div class="sum-chip">EVAL RUNS<span id="sum-evals">--</span></div>
        <div class="sum-chip">PIPELINE RUNS<span id="sum-pipelines">--</span></div>
        <div class="sum-chip">DATA JOBS<span id="sum-datajobs">--</span></div>
        <div class="sum-chip">BEST SCORE<span id="sum-bestscore">--</span></div>
        <div class="sum-chip">AVG SCORE<span id="sum-avgscore">--</span></div>
        <div class="sum-chip">FINE-TUNES<span id="sum-ft">--</span></div>
      </div>
    </div>

    <!-- EVAL HISTORY -->
    <div class="info-card">
      <div class="info-card-hdr" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;">
        <span>Eval History</span>
        <div class="filter-bar">
          <label>MODEL</label>
          <input class="form-input" id="flt-model" type="text" placeholder="filter..." style="width:110px;font-size:10px;padding:3px 8px;" oninput="renderEvals()" />
          <label>SUITE</label>
          <input class="form-input" id="flt-suite" type="text" placeholder="filter..." style="width:80px;font-size:10px;padding:3px 8px;" oninput="renderEvals()" />
          <select class="form-select" id="flt-status" style="font-size:10px;padding:2px 8px;width:auto;" onchange="renderEvals()">
            <option value="all">ALL</option><option value="pass">PASS</option><option value="fail">FAIL</option>
          </select>
          <button class="action-btn" style="font-size:10px;padding:2px 10px;" onclick="exportAll('eval')">&#8659; CSV</button>
        </div>
      </div>
      <div style="overflow-x:auto">
        <table class="rpt-table">
          <thead>
            <tr><th>RUN ID</th><th>DATE</th><th>MODEL</th><th>BACKEND</th><th>JUDGE</th><th>SUITE</th><th>SCORE</th><th>PASS RATE</th><th>TIME</th><th>STATUS</th></tr>
          </thead>
          <tbody id="eval-tbody">
            <tr><td colspan="10" class="empty">NO EVAL RUNS YET</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- TRAINING RUNS -->
    <div class="info-card">
      <div class="info-card-hdr" style="display:flex;align-items:center;justify-content:space-between;">
        <span>Training Run History</span>
        <button class="action-btn" style="font-size:10px;padding:2px 10px;" onclick="exportAll('train')">&#8659; CSV</button>
      </div>
      <div style="overflow-x:auto">
        <table class="rpt-table">
          <thead>
            <tr><th>RUN ID</th><th>MODEL</th><th>DATASET</th><th>RANK</th><th>EPOCHS</th><th>LR</th><th>NODE</th><th>DURATION</th><th>FINAL LOSS</th><th>STATUS</th></tr>
          </thead>
          <tbody id="train-tbody">
            <tr><td colspan="10" class="empty">NO TRAINING RUNS YET</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- PIPELINE RUNS -->
    <div class="info-card">
      <div class="info-card-hdr" style="display:flex;align-items:center;justify-content:space-between;">
        <span>Pipeline Run History</span>
        <button class="action-btn" style="font-size:10px;padding:2px 10px;" onclick="exportAll('pipeline')">&#8659; CSV</button>
      </div>
      <div style="overflow-x:auto">
        <table class="rpt-table">
          <thead>
            <tr><th>RUN ID</th><th>MODEL</th><th>BACKEND</th><th>SUITE</th><th>TARGET</th><th>ITERS</th><th>FINAL SCORE</th><th>NODE</th><th>DURATION</th><th>STATUS</th></tr>
          </thead>
          <tbody id="pipeline-tbody">
            <tr><td colspan="10" class="empty">NO PIPELINE RUNS YET</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <div class="log-panel" id="log">
    <div class="log-line"><span class="log-time">--:--:--</span><span class="log-msg info">REPORTS module ready. Historical data populates as runs complete.</span></div>
  </div>
</div>

<div class="footer">
  <span>BOB-AI // BCOM-C v0.1</span>
  <span id="footer-date"></span>
  <span>SESSION ACTIVE</span>
</div>

<!-- TERMINAL DOCK -->
<div class="terminal-dock" id="terminal-dock">
  <div class="terminal-bar">
    <div class="terminal-tabs">
      <div class="terminal-tab active" data-term="spark" onclick="switchTerm('spark')">SPARK-BOB</div>
      <div class="terminal-tab" data-term="linux" onclick="switchTerm('linux')">LINUX-DSKTP</div>
    </div>
    <div class="terminal-controls">
      <button class="term-ctrl" id="term-minimize" title="Minimize">_</button>
    </div>
  </div>
  <div class="terminal-body" id="terminal-body">
    <div class="terminal-output" id="term-out-spark"><div class="term-line sys">[bcom-c] reports terminal ready</div></div>
    <div class="terminal-output" id="term-out-linux" style="display:none"><div class="term-line sys">[bcom-c] reports terminal ready</div></div>
    <div class="terminal-input-row">
      <span class="term-prompt" id="term-prompt">$</span>
      <input class="terminal-input" id="terminal-input" type="text" autocomplete="off" spellcheck="false" placeholder="type command..." />
    </div>
  </div>
</div>

<script src="../assets/js/bcom.js?v=5"></script>
<script>
  BCOM.apiBase      = '';   // '' = same-origin (Caddy proxies /api/* → Spark)
  BCOM.pollInterval = 5000;
  startPolling();

  // ── Live data arrays (populated by API) ─────────────────────────────
  let _evals     = [];
  let _trains    = [];
  let _pipelines = [];

  function sc(n) { return n >= 80 ? 'score-hi' : n >= 65 ? 'score-mid' : 'score-lo'; }

  function renderEvals() {
    const fm  = document.getElementById('flt-model').value.toLowerCase();
    const fs  = document.getElementById('flt-suite').value.toLowerCase();
    const fst = document.getElementById('flt-status').value;
    let d = _evals;
    if (fm)          d = d.filter(r => r.model.toLowerCase().includes(fm));
    if (fs)          d = d.filter(r => r.suite.toLowerCase().includes(fs));
    if (fst !== 'all') d = d.filter(r => r.status === fst);
    const tb = document.getElementById('eval-tbody');
    if (!d.length) { tb.innerHTML = '<tr><td colspan="10" class="empty">NO EVAL RUNS YET</td></tr>'; return; }
    tb.innerHTML = d.map(r => `<tr>
      <td style="color:var(--orange-dark)">${r.id}</td>
      <td style="color:#999">${r.date}</td><td>${r.model}</td><td>${r.backend}</td>
      <td>${r.judge}</td><td>${r.suite}</td>
      <td class="${sc(r.score)}">${r.score}%</td>
      <td>${r.passrate}</td><td style="color:#999">${r.time}</td>
      <td><span class="rpt-pill ${r.status}">${r.status.toUpperCase()}</span></td>
    </tr>`).join('');
  }

  function renderTrains() {
    const tb = document.getElementById('train-tbody');
    if (!_trains.length) { tb.innerHTML = '<tr><td colspan="10" class="empty">NO TRAINING RUNS YET</td></tr>'; return; }
    tb.innerHTML = _trains.map(r => `<tr>
      <td style="color:var(--orange-dark)">${r.id}</td>
      <td>${r.model}</td><td style="font-size:10px;color:#999">${r.dataset}</td>
      <td>${r.rank}</td><td>${r.epochs}</td><td>${r.lr}</td><td>${r.node}</td>
      <td>${r.dur}</td><td class="${sc(parseFloat(r.loss)<0.09?85:parseFloat(r.loss)<0.12?70:55)}">${r.loss}</td>
      <td><span class="rpt-pill ${r.status}">${r.status.toUpperCase()}</span></td>
    </tr>`).join('');
  }

  function renderPipelines() {
    const tb = document.getElementById('pipeline-tbody');
    if (!_pipelines.length) { tb.innerHTML = '<tr><td colspan="10" class="empty">NO PIPELINE RUNS YET</td></tr>'; return; }
    tb.innerHTML = _pipelines.map(r => `<tr>
      <td style="color:var(--orange-dark)">${r.id}</td>
      <td>${r.model}</td><td>${r.backend}</td><td>${r.suite}</td><td>${r.target}</td>
      <td>${r.iters}</td><td class="${sc(parseInt(r.score))}">${r.score}</td>
      <td>${r.node}</td><td>${r.dur}</td>
      <td><span class="rpt-pill ${r.status}">${r.status.toUpperCase()}</span></td>
    </tr>`).join('');
  }

  // ── Live summary from API ────────────────────────────────────────────
  async function pollReportsSummary() {
    try {
      const res = await fetch('/api/reports/summary', { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const d = await res.json();
      setText('sum-evals',     d.eval_runs     ?? '--');
      setText('sum-pipelines', d.pipelines     ?? '--');
      setText('sum-datajobs',  d.datagen_jobs  ?? '--');
      setText('sum-ft',        d.finetune_jobs ?? '--');
      if (!d.eval_runs) {
        setText('sum-bestscore', '--');
        setText('sum-avgscore',  '--');
      }
    } catch (err) {
      logLine('Reports summary error: ' + err.message, 'warn');
    }
  }

  // ── Live table data from API ─────────────────────────────────────────
  async function pollReportsTables() {
    const [evalsRes, trainsRes, plRes] = await Promise.allSettled([
      fetch('/api/evals/',          { cache: 'no-store' }),
      fetch('/api/training/runs/',  { cache: 'no-store' }),
      fetch('/api/pipelines/runs/', { cache: 'no-store' }),
    ]);
    if (evalsRes.status === 'fulfilled' && evalsRes.value.ok)
      try { _evals = await evalsRes.value.json(); } catch(_) {}
    if (trainsRes.status === 'fulfilled' && trainsRes.value.ok)
      try { _trains = await trainsRes.value.json(); } catch(_) {}
    if (plRes.status === 'fulfilled' && plRes.value.ok)
      try { _pipelines = await plRes.value.json(); } catch(_) {}
    renderEvals(); renderTrains(); renderPipelines();
  }

  function renderSummary() { pollReportsSummary(); }

  function exportAll(type) {
    logLine(`CMD: EXPORT ${type.toUpperCase()} — CSV`, 'info');
    if (BCOM.apiBase === null) logLine('No API — export unavailable', 'warn');
  }

  renderSummary();
  pollReportsTables();
  setInterval(pollReportsTables, 30000);

  // Terminal
  let _termNode = 'spark';
  function switchTerm(node) {
    _termNode = node;
    document.querySelectorAll('.terminal-tab').forEach(t => t.classList.toggle('active', t.dataset.term === node));
    ['spark','linux'].forEach(n => { const el = document.getElementById('term-out-'+n); if (el) el.style.display = n===node?'block':'none'; });
    document.getElementById('term-prompt').textContent = (node==='spark'?'spark-bob':'linux-dsktp')+' $';
    document.getElementById('terminal-input').focus();
  }
  function termLine(text, cls) {
    const out = document.getElementById('term-out-'+_termNode); if (!out) return;
    const div = document.createElement('div'); div.className = 'term-line'+(cls?' '+cls:''); div.textContent = text;
    out.appendChild(div); out.scrollTop = out.scrollHeight;
  }
  document.getElementById('terminal-input').addEventListener('keydown', e => {
    if (e.key !== 'Enter') return;
    const cmd = e.target.value.trim(); if (!cmd) return;
    termLine((_termNode==='spark'?'spark-bob':'linux-dsktp')+' $ '+cmd); e.target.value = '';
    if (BCOM.apiBase === null) termLine('[bcom-c] no API — command not sent', 'dim');
  });
  document.getElementById('term-minimize').addEventListener('click', () => {
    const dock = document.getElementById('terminal-dock');
    const body = document.getElementById('terminal-body');
    const btn  = document.getElementById('term-minimize');
    const isMin = dock.classList.toggle('minimized');
    body.style.display = isMin ? 'none' : '';
    btn.textContent = isMin ? '▲' : '_';
    document.body.style.paddingBottom = isMin ? '34px' : '220px';
  });
  switchTerm('spark');
</script>
</body>
</html>
