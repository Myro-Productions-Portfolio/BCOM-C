<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>BCOM-C — Resources</title>
<script>
  (function(){
    var t=localStorage.getItem("bcom-theme")||"dark";
    document.documentElement.setAttribute("data-theme",t);
    try { var raw=localStorage.getItem("bcom-theme-vars"); if(raw){ var vars=JSON.parse(raw); Object.keys(vars).forEach(function(k){ document.documentElement.style.setProperty(k,vars[k]); }); } } catch(_) {}
  })();
</script>
<link rel="stylesheet" href="../assets/css/bcom.css?v=3" />
<style>
  .reg-table { width:100%; border-collapse:collapse; font-size:12px; letter-spacing:.5px; }
  .reg-table th { background:#0e0a06; color:#ccc; font-weight:600; letter-spacing:1.5px; padding:7px 10px; text-align:left; border-bottom:1px solid #1e1008; }
  .reg-table td { padding:7px 10px; border-bottom:1px solid #120b04; vertical-align:middle; color:#ccc; }
  .reg-table tr:hover td { background:#0e0905; }
  .reg-table .empty { text-align:center; color:#2a2a2a; padding:24px; letter-spacing:2px; }
  .mdl-pill { display:inline-block; font-size:9px; letter-spacing:1.5px; padding:2px 7px; border:1px solid; }
  .mdl-pill.loaded  { color:#27ae60; border-color:#27ae60; }
  .mdl-pill.cached  { color:var(--orange); border-color:var(--orange-dark); }
  .mdl-pill.avail   { color:#444; border-color:#333; }
  .mdl-pill.pulling { color:#f39c12; border-color:#f39c12; }
  .stor-grid { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
  .stor-node { padding:12px; border:1px solid #1a0e05; background:#090603; }
  .stor-hdr  { font-size:11px; letter-spacing:2px; color:var(--orange-dark); margin-bottom:10px; font-weight:700; }
  .stor-row  { margin-bottom:8px; }
  .stor-label{ font-size:10px; letter-spacing:1px; color:#ccc; display:flex; justify-content:space-between; margin-bottom:3px; }
  .stor-track{ background:#0e0905; height:6px; }
  .stor-fill { height:6px; background:var(--orange-dark); transition:width .6s; }
  .stor-fill.warn   { background:#f39c12; }
  .stor-fill.danger { background:#e74c3c; }
  .compute-chip { font-size:11px; letter-spacing:1px; color:#ccc; border:1px solid #1a0e05; padding:6px 12px; background:#090603; min-width:120px; }
  .compute-chip span { color:var(--orange); display:block; font-weight:700; font-size:13px; margin-top:2px; }
  .compute-row { display:flex; gap:10px; flex-wrap:wrap; margin-top:6px; }
</style>
</head>
<body>

<div class="topbar">
  <div class="topbar-title">BCOM-C</div>
  <div class="topbar-right">
    <a class="nav-btn" href="../index.html"><span class="nav-arrow">&#8592;</span> DASHBOARD</a>
    <a class="nav-btn" href="data-gen.html">DATA GEN</a>
    <a class="nav-btn" href="pipeline.html">PIPELINE</a>
    <a class="nav-btn active" href="resources.html">RESOURCES</a>
    <a class="nav-btn" href="reports.html">REPORTS</a>
    <a class="nav-btn" href="orchestrator.html">ORCHESTRATOR</a>
    <a class="cog-btn" href="settings.html" title="Settings">⚙</a>
    <div class="timestamp"><span id="clock">--:--:--</span>&nbsp;&nbsp;<span id="datestamp">----/--/--</span></div>
  </div>
</div>

<div class="actionbar">
  <button class="action-btn danger" onclick="triggerAction('RESTART VLLM')">RESTART VLLM</button>
  <button class="action-btn danger" onclick="triggerAction('RESTART LLM')">RESTART LLM</button>
  <button class="action-btn" onclick="pullModel()">&#8659; PULL MODEL</button>
  <button class="action-btn" onclick="refreshAll()">&#8635; REFRESH</button>
</div>

<div class="main">
  <div class="info-grid">

    <!-- MODEL REGISTRY -->
    <div class="info-card">
      <div class="info-card-hdr" style="display:flex;align-items:center;justify-content:space-between;">
        <span>Model Registry</span>
        <div style="display:flex;gap:8px;">
          <select class="form-select" id="reg-filter-node" style="font-size:10px;padding:2px 8px;width:auto;" onchange="renderRegistry()">
            <option value="all">ALL NODES</option>
            <option value="spark">SPARK-BOB</option>
            <option value="linux">LINUX-DSKTP</option>
          </select>
          <select class="form-select" id="reg-filter-status" style="font-size:10px;padding:2px 8px;width:auto;" onchange="renderRegistry()">
            <option value="all">ALL STATUS</option>
            <option value="loaded">LOADED</option>
            <option value="cached">CACHED</option>
            <option value="avail">AVAILABLE</option>
          </select>
        </div>
      </div>
      <div style="overflow-x:auto">
        <table class="reg-table">
          <thead>
            <tr><th>MODEL</th><th>TYPE</th><th>SIZE</th><th>BACKEND</th><th>NODE</th><th>VRAM REQ</th><th>QUANT</th><th>STATUS</th><th>ACTIONS</th></tr>
          </thead>
          <tbody id="reg-body">
            <tr><td colspan="9" class="empty">AWAITING CONNECTION</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- PULL MODEL -->
    <div class="info-card">
      <div class="info-card-hdr">Pull / Register Model</div>
      <div class="form-body">
        <div class="form-row-3">
          <div class="form-group">
            <label class="form-label">Model ID or Path</label>
            <input class="form-input" id="pull-id" type="text" placeholder="e.g. mistral:7b-q4" />
          </div>
          <div class="form-group">
            <label class="form-label">Backend</label>
            <select class="form-select" id="pull-backend">
              <option>Ollama</option><option>vLLM</option><option>HuggingFace</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Node</label>
            <select class="form-select" id="pull-node">
              <option value="spark">SPARK-BOB</option>
              <option value="linux">LINUX-DSKTP</option>
            </select>
          </div>
        </div>
        <div class="form-row-3">
          <div class="form-group">
            <label class="form-label">Quantization</label>
            <select class="form-select" id="pull-quant">
              <option>Q4_K_M</option><option>Q5_K_M</option><option>Q8_0</option><option>FP16</option><option>FP32</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Tag / Version</label>
            <input class="form-input" id="pull-tag" type="text" placeholder="latest" />
          </div>
          <div class="form-group" style="display:flex;align-items:flex-end;">
            <button class="form-submit" style="margin-top:0;width:100%" onclick="pullModel()">&#8659; Pull</button>
          </div>
        </div>
        <div class="form-output" id="pull-output">--</div>
      </div>
    </div>

    <!-- STORAGE -->
    <div class="info-card">
      <div class="info-card-hdr">Storage Overview</div>
      <div class="stor-grid">
        <div class="stor-node">
          <div class="stor-hdr">SPARK-BOB</div>
          <div class="stor-row">
            <div class="stor-label"><span>MODELS</span><span id="stor-spark-models">-- / --</span></div>
            <div class="stor-track"><div class="stor-fill" id="sf-spark-models" style="width:0%"></div></div>
          </div>
          <div class="stor-row">
            <div class="stor-label"><span>DATASETS</span><span id="stor-spark-data">-- / --</span></div>
            <div class="stor-track"><div class="stor-fill" id="sf-spark-data" style="width:0%"></div></div>
          </div>
          <div class="stor-row">
            <div class="stor-label"><span>CHECKPOINTS</span><span id="stor-spark-ckpt">-- / --</span></div>
            <div class="stor-track"><div class="stor-fill" id="sf-spark-ckpt" style="width:0%"></div></div>
          </div>
          <div class="stor-row">
            <div class="stor-label"><span>ROOT FS</span><span id="stor-spark-root">-- / --</span></div>
            <div class="stor-track"><div class="stor-fill" id="sf-spark-root" style="width:0%"></div></div>
          </div>
        </div>
        <div class="stor-node">
          <div class="stor-hdr">LINUX-DSKTP</div>
          <div class="stor-row">
            <div class="stor-label"><span>MODELS</span><span id="stor-linux-models">-- / --</span></div>
            <div class="stor-track"><div class="stor-fill" id="sf-linux-models" style="width:0%"></div></div>
          </div>
          <div class="stor-row">
            <div class="stor-label"><span>DATASETS</span><span id="stor-linux-data">-- / --</span></div>
            <div class="stor-track"><div class="stor-fill" id="sf-linux-data" style="width:0%"></div></div>
          </div>
          <div class="stor-row">
            <div class="stor-label"><span>CHECKPOINTS</span><span id="stor-linux-ckpt">-- / --</span></div>
            <div class="stor-track"><div class="stor-fill" id="sf-linux-ckpt" style="width:0%"></div></div>
          </div>
          <div class="stor-row">
            <div class="stor-label"><span>ROOT FS</span><span id="stor-linux-root">-- / --</span></div>
            <div class="stor-track"><div class="stor-fill" id="sf-linux-root" style="width:0%"></div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- COMPUTE ALLOCATION -->
    <div class="info-card">
      <div class="info-card-hdr">Compute Allocation</div>
      <div class="node-cols">
        <div class="node-col">
          <div class="node-col-hdr"><div class="status-dot"></div>SPARK-BOB</div>
          <div class="compute-row">
            <div class="compute-chip">GPU ALLOC<span id="ca-spark-gpu">--</span></div>
            <div class="compute-chip">VRAM USED<span id="ca-spark-vram">--</span></div>
            <div class="compute-chip">CPU CORES<span id="ca-spark-cpu">--</span></div>
            <div class="compute-chip">PROCESSES<span id="ca-spark-procs">--</span></div>
          </div>
        </div>
        <div class="node-col">
          <div class="node-col-hdr"><div class="status-dot"></div>LINUX-DSKTP</div>
          <div class="compute-row">
            <div class="compute-chip">GPU ALLOC<span id="ca-linux-gpu">--</span></div>
            <div class="compute-chip">RAM USED<span id="ca-linux-ram">--</span></div>
            <div class="compute-chip">CPU CORES<span id="ca-linux-cpu">--</span></div>
            <div class="compute-chip">PROCESSES<span id="ca-linux-procs">--</span></div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <div class="log-panel" id="log">
    <div class="log-line"><span class="log-time">--:--:--</span><span class="log-msg info">RESOURCES module ready. Connect API to populate live data.</span></div>
  </div>
</div>

<div class="footer">
  <span>BOB-AI // BCOM-C v0.1</span>
  <span id="footer-date"></span>
  <span>SESSION ACTIVE</span>
</div>

<!-- TERMINAL DOCK -->
<div class="terminal-dock" id="terminal-dock">
  <div class="terminal-bar">
    <div class="terminal-tabs">
      <div class="terminal-tab active" data-term="spark" onclick="switchTerm('spark')">SPARK-BOB</div>
      <div class="terminal-tab" data-term="linux" onclick="switchTerm('linux')">LINUX-DSKTP</div>
    </div>
      <div class="terminal-tab" data-term="shell">SHELL</div>
    <div class="terminal-controls">
      <button class="term-ctrl" id="term-minimize" title="Minimize">_</button>
    </div>
  </div>
  <div class="terminal-body" id="terminal-body">
    <div class="terminal-output" id="term-out-spark"><div class="term-line sys">[bcom-c] resources terminal ready</div></div>
    <div class="terminal-output" id="term-out-linux" style="display:none"><div class="term-line sys">[bcom-c] resources terminal ready</div></div>
    <div id="xterm-container" style="display:none;flex:1;min-height:0;width:100%;background:#080808;"></div>
    <div class="terminal-input-row">
      <span class="term-prompt" id="term-prompt">$</span>
      <input class="terminal-input" id="terminal-input" type="text" autocomplete="off" spellcheck="false" placeholder="type command..." />
    </div>
  </div>
</div>

<script src="../assets/js/bcom.js?v=5"></script>
<script>
  BCOM.apiBase      = '';   // '' = same-origin (Caddy proxies /api/* → Spark)
  BCOM.pollInterval = 5000;
  startPolling();

  // ── Live model list ────────────────────────────────────────────────
  let _sparkModels = [];
  let _linuxModels = [];

  function _liveToRegistry(models, node) {
    return models.map(m => ({
      id:      m.name ?? m.model ?? '--',
      type:    (m.details?.family ?? 'llm').toUpperCase(),
      size:    m.size ? (m.size / 1e9).toFixed(1) + ' GB' : '--',
      backend: 'Ollama',
      node:    node,
      vram:    '--',
      quant:   m.details?.quantization_level ?? '--',
      status:  'loaded',
    }));
  }

  function renderRegistry() {
    const fn = document.getElementById('reg-filter-node').value;
    const fs = document.getElementById('reg-filter-status').value;
    let m = [
      ..._liveToRegistry(_sparkModels, 'spark'),
      ..._liveToRegistry(_linuxModels, 'linux'),
    ];
    if (fn !== 'all') m = m.filter(x => x.node === fn);
    if (fs !== 'all') m = m.filter(x => x.status === fs);
    const tb = document.getElementById('reg-body');
    if (!m.length) {
      tb.innerHTML = '<tr><td colspan="9" class="empty">NO MODELS LOADED</td></tr>';
      return;
    }
    tb.innerHTML = m.map(x => `<tr>
      <td style="color:var(--orange-dark);font-weight:600">${x.id}</td>
      <td>${x.type}</td><td>${x.size}</td><td>${x.backend}</td>
      <td>${x.node==='spark'?'SPARK-BOB':'LINUX-DSKTP'}</td>
      <td>${x.vram}</td><td style="color:#999">${x.quant}</td>
      <td><span class="mdl-pill ${x.status}">${x.status.toUpperCase()}</span></td>
      <td style="display:flex;gap:4px;">
        <button class="ctr-btn" onclick="loadModel('${x.id}')">LOAD</button>
        <button class="ctr-btn" onclick="removeModel('${x.id}')">RM</button>
      </td>
    </tr>`).join('');
  }

  function loadModel(id)   { logLine(`CMD: LOAD — ${id}`, 'info'); }
  function removeModel(id) { logLine(`CMD: REMOVE — ${id}`, 'warn'); }

  function pullModel() {
    const id = document.getElementById('pull-id').value.trim();
    const bk = document.getElementById('pull-backend').value;
    const nd = document.getElementById('pull-node').value;
    if (!id) { logLine('Form error: Model ID required', 'warn'); return; }
    const t = new Date().toTimeString().split(' ')[0];
    logLine(`CMD: PULL — ${id} via ${bk} on ${nd==='spark'?'SPARK-BOB':'LINUX-DSKTP'}`, 'info');
    const out = document.getElementById('pull-output');
    out.textContent = `[${t}] Pull queued: ${id}`;
    out.style.color = 'var(--orange-dark)';
  }

  function setStorBar(id, labelId, used, total) {
    if (!total) return;
    const pct = Math.min(100, Math.round(used / total * 100));
    const el  = document.getElementById(id);
    if (el) {
      el.style.width = pct + '%';
      el.className   = 'stor-fill' + (pct >= 90 ? ' danger' : pct >= 75 ? ' warn' : '');
    }
    const lbl = document.getElementById(labelId);
    if (lbl) lbl.textContent = `${used} GB / ${total} GB`;
  }

  // ── Resource page poll (system stats, storage, models) ─────────────
  async function pollResourcePage() {
    try {
      const [statsRes, infoRes, storageRes, modelsRes, linuxRes, linuxModelsRes] = await Promise.allSettled([
        fetch('/api/system/stats',        { cache: 'no-store' }),
        fetch('/api/system/info',         { cache: 'no-store' }),
        fetch('/api/system/storage',      { cache: 'no-store' }),
        fetch('/api/models/',             { cache: 'no-store' }),
        fetch('/api/system/linux/stats',  { cache: 'no-store' }),
        fetch('/api/models/linux',        { cache: 'no-store' }),
      ]);

      // Spark stats → compute chips
      if (statsRes.status === 'fulfilled' && statsRes.value.ok) {
        const s = await statsRes.value.json();
        const g = s.gpu ?? {};
        setText('ca-spark-gpu',   g.name ? `${g.name}` : '--');
        setText('ca-spark-procs', s.cpu_percent !== undefined
          ? `${s.cpu_percent.toFixed(1)}% CPU` : '--');
      }

      // Spark info → cpu_count
      if (infoRes.status === 'fulfilled' && infoRes.value.ok) {
        const info = await infoRes.value.json();
        setText('ca-spark-cpu', info.cpu_count ? `${info.cpu_count} cores` : '--');
      }

      // Spark storage → bars
      if (storageRes.status === 'fulfilled' && storageRes.value.ok) {
        const stor = await storageRes.value.json();
        const sp   = stor.spark ?? {};
        if (sp.models)      setStorBar('sf-spark-models','stor-spark-models', sp.models.used_gb,      sp.models.total_gb);
        if (sp.datasets)    setStorBar('sf-spark-data',  'stor-spark-data',   sp.datasets.used_gb,    sp.datasets.total_gb);
        if (sp.checkpoints) setStorBar('sf-spark-ckpt',  'stor-spark-ckpt',   sp.checkpoints.used_gb, sp.checkpoints.total_gb);
        if (sp.root)        setStorBar('sf-spark-root',  'stor-spark-root',   sp.root.used_gb,        sp.root.total_gb);
      }

      // Spark models → registry table
      if (modelsRes.status === 'fulfilled' && modelsRes.value.ok) {
        const mdl = await modelsRes.value.json();
        _sparkModels = mdl.models ?? (Array.isArray(mdl) ? mdl : []);
        renderRegistry();
      }

      // Linux Desktop models → merge into registry table
      if (linuxModelsRes.status === 'fulfilled' && linuxModelsRes.value.ok) {
        const lmdl = await linuxModelsRes.value.json();
        _linuxModels = (!lmdl.error && lmdl.models) ? lmdl.models : [];
        renderRegistry();
      }

      // Linux desktop → compute chips + storage bars
      if (linuxRes.status === 'fulfilled' && linuxRes.value.ok) {
        const lx = await linuxRes.value.json();
        if (!lx.error) {
          setText('ca-linux-gpu',   'NONE');
          setText('ca-linux-cpu',   lx.cpu_count ? `${lx.cpu_count} cores` : '--');
          setText('ca-linux-ram',   lx.memory?.used_gb != null
            ? `${lx.memory.used_gb} / ${lx.memory.total_gb} GB` : '--');
          setText('ca-linux-procs', lx.procs_running != null
            ? `${lx.procs_running} running` : '--');

          const d = lx.disk ?? {};
          if (d.root)    setStorBar('sf-linux-root',   'stor-linux-root',   d.root.used_gb,    d.root.total_gb);
          if (d.ubdrive) setStorBar('sf-linux-models', 'stor-linux-models', d.ubdrive.used_gb, d.ubdrive.total_gb);
          if (d.ubdrive) setStorBar('sf-linux-data',   'stor-linux-data',   d.ubdrive.used_gb, d.ubdrive.total_gb);
        }
      }

    } catch (err) {
      logLine('Resource poll error: ' + err.message, 'warn');
    }
  }

  function refreshAll() {
    logLine('Resources refreshed', 'info');
    pollResourcePage();
  }

  // Initial load + recurring poll
  pollResourcePage();
  setInterval(pollResourcePage, 10000); // storage is slow (du), 10s is fine

  // Terminal
  let _termNode = 'spark';
  function switchTerm(node) {
    _termNode = node;
    document.querySelectorAll('.terminal-tab').forEach(t => t.classList.toggle('active', t.dataset.term === node));
    ['spark','linux'].forEach(n => { const el = document.getElementById('term-out-'+n); if (el) el.style.display = n===node?'block':'none'; });
    document.getElementById('term-prompt').textContent = (node==='spark'?'spark-bob':'linux-dsktp')+' $';
    document.getElementById('terminal-input').focus();
  }
  function termLine(text, cls) {
    const out = document.getElementById('term-out-'+_termNode); if (!out) return;
    const div = document.createElement('div'); div.className = 'term-line'+(cls?' '+cls:''); div.textContent = text;
    out.appendChild(div); out.scrollTop = out.scrollHeight;
  }
  // terminal input wired by bcom-terminal.js
  // minimize wired by bcom-terminal.js
  switchTerm('spark');
</script>
  <script src="../assets/js/bcom-terminal.js?v=3"></script>
</body>
</html>
